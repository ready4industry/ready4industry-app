<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skills Challenge Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
    rel="stylesheet"
  />
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f9fafb;
    }
    #app-root {
      min-height: 100vh;
    }
    .transition-all-slow {
      transition: all 0.3s ease-in-out;
    }
  </style>
</head>

<body class="p-4 md:p-8">
  <div id="app-root">
    <div id="content-container"></div>
  </div>

  <div
    id="user-message-box"
    class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 opacity-0 pointer-events-none"
  ></div>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://glskwkzzkhhwftzddqmo.supabase.co"; // Replace with your Supabase URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdsc2t3a3p6a2hod2Z0emRkcW1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MDg2OTEsImV4cCI6MjA3NTA4NDY5MX0.g3XQyV6T_xfBCSOb0X1idGNmD0zEBbMhX8RZ1PLH5R8"; // Replace with your Supabase Anon Key
    const RAZORPAY_KEY_ID = "rzp_test_YOUR_KEY_ID"; // ⭐️ IMPORTANT: Replace with your actual Test/Live Razorpay Key ID ⭐️
    
    // The Edge Function URL is derived from the Supabase URL
    const SUPABASE_EDGE_FUNCTION_URL = `${SUPABASE_URL.replace(
      /\/$/,
      ""
    )}/functions/v1/assessment-api`;

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TIME_LIMIT_SECONDS = 10 * 60; // 10 minutes
    const QUESTIONS_PER_MODULE = 10;
    
    // --- STATE MANAGEMENT ---
    let appState = {};
    let currentUserId = null;
    let currentModule = null;
    let questions = [];
    let currentQuestionIndex = 0;
    let selectedAnswers = {}; // Stores { question_id: selected_index }
    let timeLeft = TIME_LIMIT_SECONDS;
    let timerInterval = null;
    let quizState = "ready"; // 'ready', 'active', 'finished'

    const MODULES = [
      {
        id: "technical",
        name: "Technical Foundation Check (B.Tech Curriculum)",
        topic: "Fundamental Computer Science and Core Engineering Concepts",
        completed: false,
        score: null,
        assessment_id: null, // Stores the active assessment ID
      },
      {
        id: "aptitude",
        name: "Aptitude and Quantitative Reasoning",
        topic: "Basic Arithmetic, Algebra, and Logical Puzzles",
        completed: false,
        score: null,
        assessment_id: null,
      },
      {
        id: "behavioral",
        name: "Behavioural and HR Fundamentals",
        topic: "Professional Ethics, Teamwork, and Communication Skills",
        completed: false,
        score: null,
        assessment_id: null,
      },
    ];

    // --- HELPER FUNCTIONS ---
    const showUserMessage = (message, type = "info") => {
      const box = document.getElementById("user-message-box");
      box.textContent = message;
      box.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl font-semibold transition-opacity duration-300 opacity-100 pointer-events-auto ${
        type === "error"
          ? "bg-red-500"
          : type === "success"
          ? "bg-green-500"
          : "bg-blue-500"
      }`;

      setTimeout(() => {
        box.className = box.className.replace("opacity-100", "opacity-0");
      }, 3000);
    };

    const loadState = (userId) => {
      // In a real app, this would fetch data from the DB. 
      // For now, we initialize with MODULES structure.
      return {
        modules: JSON.parse(JSON.stringify(MODULES)), // Deep copy
        totalScore: 0,
        reportPaid: false, // NEW: Payment status
      };
    };
    
    // --- TIMER LOGIC ---
    const startTimer = () => {
      if (timerInterval) clearInterval(timerInterval);
      
      const timerFunction = () => {
        timeLeft--;
        mainRender(); // Re-render to update the timer
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          showUserMessage("Time's up! Submitting your answers.", "info");
          handleSubmitQuiz(); 
        }
      };
      
      timerInterval = setInterval(timerFunction, 1000);
    };
    
    const formatTime = (seconds) => {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    };

    // --- QUIZ FLOW FUNCTIONS ---

    const startQuiz = (module) => {
      currentModule = appState.modules.find(m => m.id === module.id);
      if (currentModule.completed) {
        showUserMessage(`${currentModule.name} is already completed.`, 'info');
        return;
      }
      quizState = "loading";
      mainRender();
      fetchQuestions(currentModule);
    };

    const fetchQuestions = async (m) => {
      try {
        const { data: { session }, error: sessionError } =
          await supabase.auth.getSession();
        if (sessionError || !session) {
          throw new Error("User not logged in. Please sign in again.");
        }

        const token = session.access_token;

        const res = await fetch(SUPABASE_EDGE_FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            action: "generate_questions",
            topic: m.topic,
            count: QUESTIONS_PER_MODULE,
            moduleId: m.id,
          }),
        });
        
        if (!res.ok) {
          const errData = await res.json().catch(() => ({ error: 'Invalid JSON response from AI' }));
          throw new Error(errData.error || `Question generation failed with status ${res.status}`);
        }

        const fetchedData = await res.json(); 
        const fetchedQuestions = fetchedData.questions;
        if (!Array.isArray(fetchedQuestions) || fetchedQuestions.length === 0) {
          throw new Error("AI returned zero or invalid questions.");
        }

        questions = fetchedQuestions;
        // ⭐️ UPDATED: Capture and store the assessment_id ⭐️
        currentModule.assessment_id = fetchedData.assessment_id; 
        currentQuestionIndex = 0;
        selectedAnswers = {};
        timeLeft = TIME_LIMIT_SECONDS;
        quizState = "active";
        mainRender();
        startTimer();

      } catch (e) {
        console.error("Fetch Questions Failed:", e);
        showUserMessage(`Error: ${e.message}`, 'error');
        quizState = "ready";
        mainRender();
      }
    };
    
    const selectAnswer = (questionId, index) => {
      selectedAnswers[questionId] = index;
      mainRender();
    };

    const nextQuestion = () => {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        mainRender();
      }
    };

    const prevQuestion = () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        mainRender();
      }
    };
    
    const handleSubmitQuiz = async () => {
      clearInterval(timerInterval);
      quizState = 'loading';
      mainRender();

      const m = currentModule;
      const currentAssessmentId = m.assessment_id;

      if (!currentAssessmentId) {
          showUserMessage("Error: Assessment ID is missing. Cannot submit.", "error");
          quizState = 'ready';
          mainRender();
          return;
      }

      // ⭐️ UPDATED: Prepare userAnswers object for server submission ⭐️
      const userAnswers = {};
      questions.forEach((q) => {
          // q.id is the question's UUID from the database returned by generate_questions
          userAnswers[q.id] = selectedAnswers[q.id]; 
      });

      try {
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();
          if (sessionError || !session) throw new Error("User not logged in. Please sign in again.");

          const token = session.access_token;

          const submissionResponse = await fetch(SUPABASE_EDGE_FUNCTION_URL, {
              method: 'POST',
              headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`,
              },
              body: JSON.stringify({
                  action: 'submit_assessment',
                  assessmentId: currentAssessmentId, // Pass the ID
                  userAnswers: userAnswers, // Pass the answers object
              }),
          });

          if (!submissionResponse.ok) {
              const errData = await submissionResponse.json().catch(() => ({ error: 'Invalid JSON response' }));
              throw new Error(errData.error || `Submission failed with status ${submissionResponse.status}`);
          }

          const resultData = await submissionResponse.json(); // Get the score from the server
          handleQuizComplete(resultData.score); // Use the server-provided score

      } catch (e) {
          console.error("Submission failed:", e);
          let error = `Failed to save results: ${e.message}`;
          quizState = 'ready';
          showUserMessage(error, 'error');
          mainRender();
      }
    };

    const handleQuizComplete = (finalScore) => {
      if (currentModule) {
        currentModule.completed = true;
        currentModule.score = finalScore; // Store the server-provided score
      }
      
      // Calculate total score percentage (simple average for this example)
      const completedModules = appState.modules.filter(m => m.completed);
      const totalScore = completedModules.reduce((sum, m) => sum + m.score, 0);
      appState.totalScore = completedModules.length > 0 ? Math.round(totalScore / completedModules.length) : 0;
      
      quizState = 'finished';
      currentModule = null;
      questions = [];
      mainRender();
      showUserMessage("Module completed! Score updated.", "success");
    };
    
    // ⭐️ NEW: Payment Initiation Function (Step 6A) ⭐️
    const handlePayment = async () => {
        let userEmail = '';
        let totalScore = appState.totalScore;
        
        try {
            const { data: { user, session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) throw new Error("User not logged in.");
            userEmail = user.email; // Get user email for prefill
            
            // 1. Call Backend (Edge Function) to Create Razorpay Order
            const orderResponse = await fetch(SUPABASE_EDGE_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                body: JSON.stringify({
                    action: 'create_order', // NEW action for the Edge Function
                    amount: 9900, // Amount in paise (₹99)
                    email: userEmail,
                    score: totalScore, // Pass the final score for context/metadata
                }),
            });

            if (!orderResponse.ok) {
                const err = await orderResponse.json();
                throw new Error(err.error || "Failed to create payment order.");
            }

            const { order_id } = await orderResponse.json();

            // 2. Launch Razorpay Checkout Modal
            const options = {
                key: RAZORPAY_KEY_ID,
                amount: 9900, // Amount in paise
                currency: "INR",
                name: "Ready4Industry Assessment Report",
                description: "Detailed Score and Insights",
                order_id: order_id,
                handler: function (response) {
                    // Payment successful on Razorpay's side. Webhook handles the DB update.
                    showUserMessage("Payment successful! Please wait for the mentor to share your detailed report via email.", "success");
                    appState.reportPaid = true; // Optimistic update, but relies on webhook
                    mainRender();
                },
                prefill: {
                    email: userEmail,
                },
                modal: {
                    ondismiss: () => {
                        showUserMessage("Payment window closed.", "info");
                    }
                }
            };

            const rzp1 = new Razorpay(options);
            rzp1.open();

        } catch (e) {
            console.error("Payment initiation error:", e);
            showUserMessage(`Payment initiation failed: ${e.message}. Contact mentor for direct payment.`, "error");
        }
    };


    // --- RENDERING ---

    const renderDashboard = () => {
      const allCompleted = appState.modules.every(m => m.completed);

      const moduleCards = appState.modules.map(m => `
        <div class="bg-white p-6 rounded-xl shadow-lg border ${m.completed ? 'border-green-400' : 'border-gray-200'}">
          <h3 class="text-xl font-bold text-gray-800 mb-2">${m.name}</h3>
          <p class="text-gray-600 mb-4">${m.topic}</p>
          <div class="flex items-center justify-between mt-4">
            <span class="text-sm font-semibold ${m.completed ? 'text-green-600' : 'text-yellow-600'}">
              Status: ${m.completed ? `Completed (${m.score}%)` : 'Pending'}
            </span>
            <button 
              onclick="startQuiz(appState.modules.find(mod => mod.id === '${m.id}'))"
              class="px-4 py-2 text-white font-semibold rounded-lg transition duration-150 
              ${m.completed ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}"
              ${m.completed ? 'disabled' : ''}>
              Start Quiz (10 mins)
            </button>
          </div>
        </div>
      `).join('');
      
      let finalReportSection = '';
      if (allCompleted) {
        finalReportSection = `
          <div class="mt-8 p-6 bg-yellow-50 rounded-xl border-2 border-yellow-300 shadow-md">
            <h3 class="text-2xl font-extrabold text-gray-800 text-center mb-4">Assessment Complete!</h3>
            <p class="text-center text-lg font-bold text-indigo-600 mb-4">Total Average Score: ${appState.totalScore}%</p>
            
            ${appState.reportPaid 
                ? `<div class="text-center text-green-600 font-bold text-xl">Report Paid. Please check your email for the detailed report.</div>`
                : `<button 
                    onclick="handlePayment()" 
                    class="mt-6 w-full px-6 py-3 text-lg font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg">
                    Get Detail, Score, and Insights - Pay ₹99
                  </button>
                  <p class="mt-4 text-center text-sm text-gray-600">
                    Contact the mentor at <a href="mailto:ready4industry@gmail.com" class="text-indigo-600 hover:underline">ready4industry@gmail.com</a> for assistance.
                  </p>`
            }
          </div>
        `;
      }
      

      return `
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">Skills Challenge Dashboard</h2>
          <div class="space-y-6">
            ${moduleCards}
          </div>
          ${finalReportSection}
        </div>
      `;
    };

    const renderQuiz = () => {
      if (!currentModule || questions.length === 0) return '';
      
      const q = questions[currentQuestionIndex];
      const questionId = q.id;
      const selectedIndex = selectedAnswers[questionId];

      const optionsHtml = q.options.map((option, index) => `
        <li class="mb-4">
          <label class="flex items-center p-4 border rounded-lg cursor-pointer transition-all-slow 
            ${selectedIndex === index ? 'bg-indigo-100 border-indigo-500 shadow-md' : 'bg-white hover:bg-gray-50'}"
          >
            <input 
              type="radio" 
              name="answer_${questionId}" 
              value="${index}" 
              class="form-radio h-5 w-5 text-indigo-600 transition-all-slow" 
              onclick="selectAnswer('${questionId}', ${index})"
              ${selectedIndex === index ? 'checked' : ''}
            >
            <span class="ml-4 text-gray-700 font-medium">${option}</span>
          </label>
        </li>
      `).join('');

      return `
        <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
          <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-2xl font-bold text-indigo-600">${currentModule.name}</h2>
            <div class="text-lg font-extrabold ${timeLeft < 60 ? 'text-red-500' : 'text-gray-800'}">
              Time Left: ${formatTime(timeLeft)}
            </div>
          </div>
          
          <div class="mb-6">
            <p class="text-sm text-gray-500 mb-2">Question ${currentQuestionIndex + 1} of ${questions.length}</p>
            <p class="text-xl font-semibold text-gray-900">${q.question_text}</p>
          </div>
          
          <ul class="list-none p-0 space-y-3">
            ${optionsHtml}
          </ul>
          
          <div class="flex justify-between mt-8 pt-4 border-t">
            <button 
              onclick="prevQuestion()" 
              class="px-6 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all-slow disabled:opacity-50" 
              ${currentQuestionIndex === 0 ? 'disabled' : ''}>
              &larr; Previous
            </button>
            <button 
              onclick="nextQuestion()" 
              class="px-6 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-all-slow disabled:opacity-50"
              ${currentQuestionIndex === questions.length - 1 ? 'disabled' : ''}>
              Next &rarr;
            </button>
          </div>
          
          ${currentQuestionIndex === questions.length - 1 ? `
            <div class="mt-6">
              <button 
                onclick="handleSubmitQuiz()" 
                class="w-full px-6 py-3 text-lg font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150">
                Submit Quiz
              </button>
            </div>
          ` : ''}
          
        </div>
      `;
    };

    const mainRender = () => {
      const container = document.getElementById("content-container");
      if (quizState === "loading") {
        container.innerHTML = `
          <div class="max-w-xl mx-auto text-center mt-20 p-8 bg-white rounded-xl shadow-lg">
             <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
             <p class="text-lg text-gray-700 font-medium">Generating ${QUESTIONS_PER_MODULE} questions via AI...</p>
             <p class="text-sm text-gray-500 mt-2">This may take a few seconds due to the complexity of the prompt.</p>
          </div>
        `;
      } else if (quizState === "active") {
        container.innerHTML = renderQuiz();
      } else {
        container.innerHTML = renderDashboard();
      }
    };

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", async () => {
      // Check for user session after redirect from index.html
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        // If no user, redirect back to login page (index.html)
        window.location.href = './index.html'; 
        return;
      }
      currentUserId = user.id;
      appState = loadState(currentUserId);
      mainRender();
    });
  </script>
</body>
</html>
