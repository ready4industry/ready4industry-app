<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Concepts Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            max-width: 600px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            min-height: 400px;
        }
        .quiz-option-button {
            transition: all 0.2s ease;
        }
        .quiz-option-button:not(:disabled):hover {
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            transform: translateY(-2px);
        }
        .quiz-option-button:disabled {
            background-color: #cbd5e1; /* Gray-300 */
            cursor: not-allowed;
            color: #4b5563; /* Gray-600 */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="app" class="p-4">
        <div class="container-card">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Core Concepts Check</h1>
            <p id="welcome-message" class="text-sm text-gray-600 mb-6">Loading session...</p>

            <!-- Loading View -->
            <div id="loading-view" class="flex flex-col items-center justify-center min-h-[250px] text-center">
                <div class="spinner mb-4"></div>
                <p class="text-lg text-blue-600 font-medium">Please wait, setting up session...</p>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="hidden">
                <p class="text-lg font-semibold text-gray-700 mb-6">Select a module to begin your assessment (5 questions per module):</p>
                
                <div id="assessment-buttons" class="space-y-4">
                    <!-- Buttons rendered dynamically -->
                </div>
                
                <!-- Final Result Button (Hidden by default) -->
                <button id="result-button" class="hidden mt-8 w-full p-4 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 transition" onclick="showFinalResult()">
                    Get Final Result: Pay ₹99
                </button>
            </div>

            <!-- Quiz View -->
            <div id="quiz-view" class="hidden">
                <h2 id="quiz-title" class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2"></h2>
                <div id="question-area">
                    <!-- Questions will be rendered here -->
                </div>

                <div class="mt-8 pt-4 border-t flex justify-between items-center">
                    <button id="submit-button" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition" onclick="submitQuiz()">
                        Submit Quiz
                    </button>
                    <button id="cancel-button" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 transition" onclick="showDashboard(true)">
                        Cancel and Go Back
                    </button>
                </div>
            </div>

            <!-- Result/Status Message -->
            <div id="status-message" class="hidden mt-6 p-4 bg-yellow-100 text-yellow-800 rounded-lg"></div>

        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        const EDGE_FUNCTION_URL = "https://glskwkzzkhhwftzddqmo.supabase.co/functions/v1/assessment-api";
        const QUESTION_COUNT = 5;
        const ASSESSMENT_KEY = 'assessment_completion_state';
        
        let userToken = null;
        let userEmail = null;
        let questions = [];
        let answers = {};
        let currentTopicId = null; 
        let assessmentState = {
            technical: false,
            aptitude: false,
            behavioural: false
        };

        const topics = [
            { id: 'technical', name: 'Technical Fundamentals', apiTopic: 'Technical Fundamentals', color: 'blue', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />' },
            { id: 'aptitude', name: 'Aptitude and Reasoning', apiTopic: 'Aptitude and Reasoning', color: 'green', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.24a10.03 10.03 0 010 14.884l-2.432-2.432m-4.636-4.636L12 10.707l-2 2-2 2-4 4" />' },
            { id: 'behavioural', name: 'Behavioural Assessment', apiTopic: 'Behavioural and Situational Questions', color: 'purple', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.828-1.24a6 6 0 00-10.344 0C4.829 16.76 4 18 4 18v2h5m0-10a4 4 0 11-8 0 4 4 0 018 0zm10 0a4 4 0 11-8 0 4 4 0 018 0z" />' }
        ];


        // --- STATE MANAGEMENT ---

        function loadState() {
            try {
                const storedState = localStorage.getItem(ASSESSMENT_KEY);
                if (storedState) {
                    assessmentState = JSON.parse(storedState);
                }
            } catch (e) {
                console.warn("Could not load state from localStorage. Starting fresh.", e);
            }
        }

        function saveState() {
            try {
                localStorage.setItem(ASSESSMENT_KEY, JSON.stringify(assessmentState));
            } catch (e) {
                console.error("Could not save state to localStorage.", e);
            }
        }

        function checkAllComplete() {
            return assessmentState.technical && assessmentState.aptitude && assessmentState.behavioural;
        }

        // --- UI UPDATES ---

        function updateDashboard() {
            const buttonContainer = document.getElementById('assessment-buttons');
            buttonContainer.innerHTML = '';
            loadState(); // Ensure state is fresh
            const allComplete = checkAllComplete();
            
            topics.forEach((t, index) => {
                const isCompleted = assessmentState[t.id];
                const isDisabled = isCompleted || allComplete;
                const button = document.createElement('button');
                
                button.className = `quiz-option-button w-full p-4 bg-${t.color}-500 text-white font-bold rounded-lg shadow-md flex justify-between items-center`;
                button.disabled = isDisabled;
                button.onclick = () => startQuiz(t.id, t.apiTopic);
                
                let text = `${index + 1}. ${t.name}`;
                if (isCompleted) {
                    text += ' (Completed)';
                    button.classList.add('opacity-75'); // Visual hint for completion
                    button.classList.remove(`bg-${t.color}-500`);
                    button.classList.add('bg-gray-400');
                } else {
                    button.classList.remove('bg-gray-400');
                    button.classList.add(`bg-${t.color}-500`);
                }

                button.innerHTML = `
                    <span>${text}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        ${t.icon}
                    </svg>
                `;
                buttonContainer.appendChild(button);
            });

            // Show or hide the final result button
            document.getElementById('result-button').classList.toggle('hidden', !allComplete);
        }
        
        function showFinalResult() {
             const resultMessage = `Thank you for completing all assessments! Your detailed insights and results are ready. Please pay ₹99 to proceed and contact the owner (keshav.karn@gmail.com) for further steps.`;
             document.getElementById('result-button').disabled = true;
             displayStatus(resultMessage, false);
        }

        // --- QUIZ FLOW ---

        async function startQuiz(topicId, apiTopicName) {
            if (!userToken) {
                displayStatus("Authentication failed. Please log in again.", true);
                return;
            }

            currentTopicId = topicId;
            questions = [];
            answers = {};

            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('status-message').classList.add('hidden');

            try {
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${userToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'generate_questions', topic: apiTopicName, count: QUESTION_COUNT }),
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`Failed to load questions from the server: ${errorJson.error || response.statusText}`);
                }

                questions = await response.json();
                
                if (questions.length === 0) {
                     throw new Error("The API returned an empty list of questions.");
                }

                renderQuiz();
                document.getElementById('quiz-title').textContent = `${topics.find(t => t.id === topicId).name} (${questions.length} Questions)`;
                showView('quiz-view');

            } catch (error) {
                console.error("Quiz Start Error:", error);
                displayStatus(`Error: Failed to load questions for ${apiTopicName}: ${error.message}`, true);
                showView('dashboard-view');
            }
        }
        
        function submitQuiz() {
            const totalQuestions = questions.length;
            const answeredQuestions = Object.keys(answers).length;

            if (answeredQuestions < totalQuestions) {
                // Using a custom message box instead of window.confirm for better UI/UX in a real app
                const confirmMessage = `You have only answered ${answeredQuestions} out of ${totalQuestions} questions. Are you sure you want to submit?`;
                if (!window.confirm(confirmMessage)) return; 
            }

            document.getElementById('submit-button').disabled = true;
            document.getElementById('submit-button').textContent = "Submitting...";

            // 1. Mark as complete and save state
            assessmentState[currentTopicId] = true;
            saveState();

            // 2. Submit to backend (for mock scoring)
            fetch(EDGE_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${userToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    action: 'submit_assessment', 
                    topic: currentTopicId,
                    answers: answers 
                }),
            }).then(response => response.json())
            .then(() => {
                // 3. Navigate back to dashboard and display success
                const completionStatus = checkAllComplete() ? "All modules complete!" : "Completed!";
                showDashboard();
                displayStatus(`${topics.find(t => t.id === currentTopicId).name} submitted. ${completionStatus}`, false);
            })
            .catch(error => {
                console.error("Submission Error:", error);
                displayStatus(`Error submitting assessment: ${error.message}`, true);
                showDashboard();
            })
            .finally(() => {
                document.getElementById('submit-button').disabled = false;
                document.getElementById('submit-button').textContent = "Submit Quiz";
            });
        }
        
        // --- UTILITY FUNCTIONS ---
        
        function showView(viewId) {
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showDashboard(clearStatus = false) {
            updateDashboard();
            showView('dashboard-view');
            if (clearStatus) {
                document.getElementById('status-message').classList.add('hidden');
            }
        }
        
        function parseFragment() {
            // ... (JWT parsing logic remains the same)
            const fragment = window.location.hash.substring(1);
            const params = new URLSearchParams(fragment);
            
            const accessToken = params.get('access_token');
            if (accessToken) {
                userToken = accessToken;
                try {
                    const base64Url = accessToken.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    const payload = JSON.parse(jsonPayload);
                    userEmail = payload.email;
                } catch (e) {
                    userEmail = "User";
                }
            }
        }

        function updateWelcomeMessage() {
            if (userEmail) {
                document.getElementById('welcome-message').innerHTML = `Welcome, <span class="font-bold text-gray-800">${userEmail}</span>! Please select a module to begin.`;
            } else {
                document.getElementById('welcome-message').textContent = 'Please log in to start your assessment.';
            }
        }

        function displayStatus(message, isError = false) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            if (isError) {
                statusDiv.className = 'mt-6 p-4 bg-red-100 text-red-800 rounded-lg font-medium';
            } else {
                statusDiv.className = 'mt-6 p-4 bg-green-100 text-green-800 rounded-lg font-medium';
            }
        }

        function renderQuiz() {
            // ... (Quiz rendering logic remains the same)
            const questionArea = document.getElementById('question-area');
            questionArea.innerHTML = '';
            
            questions.forEach((q, qIndex) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'mb-6 p-4 border border-gray-200 rounded-lg';
                qDiv.innerHTML = `
                    <p class="font-bold text-gray-900 mb-3">Q${qIndex + 1}. (${q.topic}) ${q.question}</p>
                `;
                
                // Shuffle options to prevent correct answer always being first
                const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5); 

                shuffledOptions.forEach((option, oIndex) => {
                    const optionId = `q${q.id}-${oIndex}`;
                    const radioName = `q-${q.id}`;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'flex items-center mb-2';
                    optionDiv.innerHTML = `
                        <input type="radio" id="${optionId}" name="${radioName}" value="${option}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 rounded" onclick="handleAnswer('${q.id}', '${option}')">
                        <label for="${optionId}" class="ml-3 text-sm font-medium text-gray-700 cursor-pointer">${option}</label>
                    `;
                    qDiv.appendChild(optionDiv);
                });
                
                questionArea.appendChild(qDiv);
            });
        }
        
        function handleAnswer(questionId, selectedOption) {
            answers[questionId] = selectedOption;
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            parseFragment();
            updateWelcomeMessage();
            loadState(); // Load state on initialization

            if (userToken) {
                showDashboard(); // Show dashboard initialized with state
            } else {
                displayStatus("No authentication token found. Please log in through the main page.", true);
                showView('dashboard-view');
            }
        };
    </script>
</body>
</html>
```

### Next Steps

1.  **Redeploy the Edge Function:** Go to your terminal and redeploy the updated `index.ts` file:
    ```bash
    supabase functions deploy assessment-api
    
