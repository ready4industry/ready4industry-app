<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Career Launchpad: Skills Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 2.5rem;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .module-button {
            transition: all 0.2s ease-in-out;
            /* Using a vibrant gradient for aesthetics */
            background-image: linear-gradient(135deg, #4F46E5, #8B5CF6); 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .module-button:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3), 0 4px 6px -2px rgba(79, 70, 229, 0.1);
        }
        .module-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .text-shadow-custom {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>

    <!-- Main Content Container -->
    <div id="app-container" class="container-card">
        <!-- Content will be rendered here by the render() function -->
    </div>

    <!-- Payment Modal (Hidden by Default) -->
    <div id="payment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity duration-300 opacity-0 pointer-events-none flex items-center justify-center z-50">
        <div class="bg-white rounded-xl overflow-hidden shadow-2xl w-full max-w-lg p-6 transform transition-transform duration-300 scale-95" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <h3 class="text-xl font-bold text-gray-900 mb-4" id="modal-title">Assessment Access Required</h3>
            <p class="text-gray-700 mb-6">This assessment requires a subscription. Please confirm your payment details to gain immediate access to the full skills challenge.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closePaymentModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">
                    Proceed to Payment
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & CONFIG ---
        
        let state = {
            // Assessment modules: Technical, Reasoning, and Behavioural. ALL ARE NOW SET TO FREE.
            modules: [
                { id: 'technical', name: 'Technical Skills', description: 'Assess your foundational knowledge and coding competency.', isPaid: false, color: 'blue', icon: 'ðŸ’»' },
                { id: 'reasoning', name: 'Logical & Quantitative Reasoning', description: 'Evaluate your problem-solving, analytical, and critical thinking skills.', isPaid: false, color: 'red', icon: 'ðŸ§ ' }, // <-- Updated to false (Free Trial)
                { id: 'behavioural', name: 'Behavioural & Cultural Fit', description: 'Examine your soft skills, communication, and workplace adaptability.', isPaid: false, color: 'green', icon: 'ðŸ’¡' }
            ],
            selectedModuleId: null, // Holds the ID of the module currently being viewed
            currentView: 'list', // 'list' or 'detail' (for the selected module)

            // NEW ASSESSMENT MOCK STATE
            currentQuestionIndex: 0, // Tracks the index of the currently viewed question
            userAnswers: {}, // Stores answers: { 'q1': 'optionA', 'q2': 'optionC' }
            assessmentData: [
                { id: 'q1', type: 'mcq', question: 'Which data structure uses LIFO (Last-In, First-Out) principle?', options: ['Queue', 'Stack', 'Array', 'Linked List'] },
                { id: 'q2', type: 'mcq', question: 'What is the primary function of the CSS box model?', options: ['Managing database connections', 'Controlling element layout and spacing', 'Handling user authentication', 'Defining JavaScript variables'] },
                { id: 'q3', type: 'mcq', question: 'In networking, what does DHCP stand for?', options: ['Domain Host Configuration Protocol', 'Dynamic Host Configuration Protocol', 'Data Handling Control Program', 'Disk High-speed Capacity Protocol'] },
            ]
        };
        
        // Define API endpoint. It will default to MOCK_URL if the environment variable is not set.
        let API_ENDPOINT = "MOCK_URL"; 
        
        // --- UTILITY FUNCTIONS ---

        /**
         * Parses the URL fragment (hash) to update the global state.
         */
        function parseFragment() {
            const hash = window.location.hash.slice(1);
            if (!hash) {
                state.selectedModuleId = null;
                state.currentView = 'list';
                state.currentQuestionIndex = 0; // Reset assessment index when leaving
                state.userAnswers = {}; // Reset answers
                return;
            }

            const params = new URLSearchParams(hash);

            if (params.has('module')) {
                state.selectedModuleId = params.get('module');
                state.currentView = 'detail';
            } else if (params.has('assessment')) {
                // If an assessment ID is in the hash, we go to the assessment view
                console.log(`Currently viewing assessment session: ${params.get('assessment')}`);
                state.currentView = 'assessment'; 
            } else {
                state.selectedModuleId = null;
                state.currentView = 'list';
            }
        }

        // --- RENDER FUNCTIONS ---
        
        /**
         * Renders the main application UI based on the current state.
         */
        function render() {
            const container = document.getElementById('app-container');
            const selectedModule = state.modules.find(m => m.id === state.selectedModuleId);
            let html = '';

            if (state.currentView === 'detail' && selectedModule) {
                html = renderModuleDetail(selectedModule);
            } else if (state.currentView === 'list') {
                html = renderModuleList();
            } else if (state.currentView === 'assessment') {
                html = renderAssessmentView();
            } else {
                 // Fallback to the list view if state is inconsistent
                html = renderModuleList();
            }

            container.innerHTML = html;
        }

        /**
         * Generates the HTML for the list of modules.
         */
        function renderModuleList() {
            return `
                <h1 class="text-4xl font-extrabold text-gray-900 mb-3">Skills Challenge Center</h1>
                <p class="text-gray-600 mb-8">Select a domain below to view the challenge details and begin your assessment.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${state.modules.map(module => `
                        <div 
                            onclick="window.location.hash = 'module=${module.id}'"
                            class="p-6 module-button text-white rounded-xl cursor-pointer shadow-lg transition duration-200 ease-in-out hover:shadow-xl"
                            style="--tw-gradient-stops: ${getGradient(module.color)};"
                        >
                            <div>
                                <div class="text-5xl mb-2 text-shadow-custom">${module.icon}</div>
                                <h2 class="text-2xl font-bold text-shadow-custom">${module.name}</h2>
                                <p class="mt-2 text-sm opacity-90">${module.description}</p>
                            </div>
                            <div class="flex flex-col items-end space-y-2">
                                <span class="text-xs font-semibold px-3 py-1 rounded-full ${module.isPaid ? 'bg-yellow-400 text-yellow-900' : 'bg-green-400 text-green-900'}">
                                    ${module.isPaid ? 'Premium' : 'Free Trial'}
                                </span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                </svg>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        /**
         * Generates the HTML for the detail view of a selected module.
         */
        function renderModuleDetail(module) {
            return `
                <button onclick="window.location.hash = ''" class="flex items-center text-indigo-600 hover:text-indigo-800 mb-6 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Challenges
                </button>
                
                <div class="flex items-center space-x-4 mb-4">
                    <div class="text-6xl">${module.icon}</div>
                    <h1 class="text-4xl font-extrabold text-gray-900">${module.name} Challenge</h1>
                </div>
                
                <p class="text-xl text-gray-700 mb-6">${module.description}</p>
                
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">Assessment Details</h2>
                    <ul class="text-gray-600 space-y-2">
                        <li class="flex items-center"><span class="font-semibold w-24">Duration:</span> 90 Minutes</li>
                        <li class="flex items-center"><span class="font-semibold w-24">Questions:</span> 3 Practical, 15 Multiple Choice</li>
                        <li class="flex items-center"><span class="font-semibold w-24">Focus:</span> Core conceptual and application skills.</li>
                    </ul>
                </div>

                <div class="flex justify-end">
                    <button 
                        id="start-assessment-btn"
                        onclick="${module.isPaid ? 'showPaymentModal()' : 'startAssessment()'}" 
                        class="px-8 py-3 text-lg font-bold text-white rounded-lg shadow-xl module-button transition duration-300 ease-in-out"
                        style="--tw-gradient-stops: #3B82F6, #6366F1;"
                    >
                        Start Assessment
                    </button>
                </div>
            `;
        }

        /**
         * Generates the HTML for the active assessment view (question template).
         */
        function renderAssessmentView() {
            const currentQ = state.assessmentData[state.currentQuestionIndex];
            
            // Fallback for assessment view (shouldn't happen with correct flow)
            if (!currentQ) {
                return `
                    <div class="text-center py-12">
                        <h1 class="text-3xl font-extrabold text-red-700">Assessment Error</h1>
                        <p class="mt-4 text-gray-600">Could not load the question content.</p>
                        <button onclick="window.location.hash = ''" class="mt-6 px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Go Back to List</button>
                    </div>
                `;
            }

            const totalQuestions = state.assessmentData.length;
            const currentNumber = state.currentQuestionIndex + 1;
            const isLastQuestion = currentNumber === totalQuestions;
            const isFirstQuestion = state.currentQuestionIndex === 0;
            const currentAnswer = state.userAnswers[currentQ.id];

            return `
                <div class="space-y-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-4 border-b border-gray-200">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2 sm:mb-0">Technical Skills Assessment</h1>
                        <div class="text-xl font-semibold text-indigo-600">
                            Question ${currentNumber} of ${totalQuestions}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <p class="text-2xl font-medium text-gray-900">${currentQ.question}</p>
                    </div>
                    
                    <div class="space-y-3">
                        ${currentQ.options.map((option, index) => {
                            // Automatically assign option letters (A, B, C, D)
                            const optionLabel = String.fromCharCode(65 + index); 
                            const isSelected = currentAnswer === option;
                            return `
                                <div 
                                    class="p-4 border-2 rounded-lg cursor-pointer transition duration-150 ease-in-out 
                                    ${isSelected ? 'bg-indigo-100 border-indigo-600 shadow-md' : 'bg-white border-gray-200 hover:border-indigo-400'}"
                                    onclick="selectAnswer('${currentQ.id}', '${option}')"
                                >
                                    <span class="font-bold text-indigo-600 mr-3">${optionLabel}.</span> 
                                    <span class="text-gray-700">${option}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="flex justify-between pt-6 border-t border-gray-200">
                        <button 
                            onclick="navigateQuestion(-1)" 
                            ${isFirstQuestion ? 'disabled' : ''}
                            class="px-6 py-2 rounded-lg font-semibold transition duration-150 
                            ${isFirstQuestion ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-gray-700 text-white hover:bg-gray-800'}"
                        >
                            Previous
                        </button>
                        
                        <button 
                            onclick="navigateQuestion(1)" 
                            class="px-6 py-2 rounded-lg font-bold text-white transition duration-150 
                            ${isLastQuestion ? 'bg-green-600 hover:bg-green-700' : 'bg-indigo-600 hover:bg-indigo-700'}"
                        >
                            ${isLastQuestion ? 'Submit Assessment' : 'Next Question'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        /**
         * Saves the selected answer for the current question and re-renders the view.
         */
        function selectAnswer(questionId, answer) {
            state.userAnswers[questionId] = answer;
            console.log(`Answer saved for ${questionId}: ${answer}`);
            render(); // Re-render to highlight the selected option
        }

        /**
         * Navigates to the next or previous question.
         * @param {number} direction - 1 for next, -1 for previous.
         */
        function navigateQuestion(direction) {
            let newIndex = state.currentQuestionIndex + direction;
            
            // Check if attempting to navigate past the last question (Submit)
            if (direction === 1 && newIndex >= state.assessmentData.length) {
                console.log("Assessment submitted! User Answers:", state.userAnswers);
                // Redirect back to the list view after submission
                window.location.hash = '';
                return;
            }
            
            // Handle boundary conditions (Previous button)
            if (newIndex < 0) {
                newIndex = 0; 
            }
            
            state.currentQuestionIndex = newIndex;
            render();
        }

        /**
         * Helper to get Tailwind color gradients for the module cards.
         */
        function getGradient(color) {
            switch(color) {
                case 'blue': return '#3B82F6, #6366F1'; // Blue to Indigo
                case 'red': return '#EF4444, #F97316'; // Red to Orange
                case 'green': return '#10B981, #34D399'; // Green to Emerald
                case 'yellow': return '#F59E0B, #FBBF24'; // Amber to Yellow
                default: return '#6B7280, #9CA3AF'; // Gray
            }
        }
        
        // --- MODAL FUNCTIONS ---

        function showPaymentModal() {
            const modal = document.getElementById('payment-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            modal.querySelector('.transform').classList.remove('scale-95');
        }

        function closePaymentModal() {
            const modal = document.getElementById('payment-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.transform').classList.add('scale-95');
        }

        // --- ASSESSMENT START LOGIC (MOCK API) ---
        
        /**
         * Handles the logic for initiating the assessment session.
         */
        async function startAssessment() {
            const selectedModule = state.modules.find(m => m.id === state.selectedModuleId);
            const button = document.getElementById('start-assessment-btn');
            
            if (!selectedModule) {
                console.error("Error: Could not find selected module.");
                return;
            }
            
            // 1. Lock the UI / Show loading state
            button.disabled = true;
            button.textContent = 'Starting Assessment...';
            button.classList.remove('hover:shadow-xl', 'hover:bg-indigo-700');
            
            try {
                // If API_ENDPOINT is not the mock URL, attempt an actual fetch.
                if (API_ENDPOINT !== "MOCK_URL") {
                    console.log(`Attempting to call API at: ${API_ENDPOINT}`);
                    
                    // In a real application, you would make a POST request here
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ moduleId: selectedModule.id, action: 'start' })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API failed with status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const assessmentSessionId = result.sessionId;

                    // 2. Redirect the user to the assessment page
                    window.location.hash = `assessment=${assessmentSessionId}`;
                    
                } else {
                    // --- MOCK LOGIC FOR TESTING ---
                    console.warn("Using mock data: API endpoint is not configured.");
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
                    const mockAssessmentSessionId = `${selectedModule.id}-${Date.now()}`;
                    
                    // 2. Redirect the user to the assessment page
                    window.location.hash = `assessment=${mockAssessmentSessionId}`;
                }

            } catch (error) {
                console.error("Error starting assessment:", error);
                
                // 3. Show error message to the user and re-enable button
                button.textContent = 'Error! Try Again.';
                button.disabled = false;
                button.classList.add('hover:shadow-xl', 'hover:bg-indigo-700');
            }
        }


        // --- INITIALIZATION ---
        
        // Try to get the real Supabase URL from the environment
        if (typeof __supabase_url !== 'undefined' && __supabase_url && !__supabase_url.includes('[Your-Supabase-Project-Ref]')) {
             const endpoint_prefix = __supabase_url.endsWith('/') ? __supabase_url.slice(0, -1) : __supabase_url;
             // IMPORTANT: This API endpoint is required for the real integration.
             API_ENDPOINT = `${endpoint_prefix}/functions/v1/assessment-api`;
        } else {
            console.warn("API URL not set. Using structured mock assessment data for testing purposes.");
        }
        
        // Listen for hash changes to update the view
        window.addEventListener('hashchange', () => {
            parseFragment();
            render();
        });
        
        // Initial load
        parseFragment();
        render();

        // Attach event listener for closing modal via ESC key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePaymentModal();
            }
        });
    </script>
</body>
</html>
