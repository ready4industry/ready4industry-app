<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTech Skills Challenge Dashboard</title>
    
    <!-- Load Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Configure Tailwind to use the Inter font (optional, but good practice) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <!-- Load React and ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Load Babel for on-the-fly JSX transpilation in the browser -->
    <!-- NOTE: This is for development/demo only; a production environment should pre-build the JS -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Base styles using the Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
    </style>
</head>
<body>

    <!-- The root element for the React application -->
    <div id="root">
        <!-- Loading message while the script loads and runs -->
        <div class="flex items-center justify-center min-h-screen bg-gray-50">
            <p class="text-lg text-gray-500">Loading Assessment Dashboard...</p>
        </div>
    </div>

    <script type="text/babel">
        // Global access to React hooks (since we are not using 'import')
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- MOCK DATA AND CONSTANTS ---
        const MOCK_USERS = {
          'user_keshav': { id: 'user_keshav', name: 'Keshav Karn', email: 'keshav.karn@example.com' },
          'user_admin': { id: 'user_admin', name: 'Mentor Admin', email: 'ready4industry@gmail.com' },
        };

        const MODULES = [
          { id: 'module_1', name: 'Technical Fundamentals', topic: 'BTech Graduate Syllabus Fundamentals' },
          { id: 'module_2', name: 'Aptitude & Reasoning', topic: 'Aptitude and Reasoning Fundamentals' },
          { id: 'module_3', name: 'Behavioural Skills', topic: 'Behavioural Fundamentals' },
        ];

        const QUESTIONS_PER_MODULE = 10;
        const TIME_LIMIT_SECONDS = 600; // 10 minutes per quiz

        // --- UTILITY FUNCTIONS ---

        const loadState = (userId) => {
          try {
            const serializedState = localStorage.getItem(`assessmentState_${userId}`);
            if (serializedState === null) {
              return {
                progress: MODULES.reduce((acc, module) => {
                  acc[module.id] = { completed: false, score: 0, started: false };
                  return acc;
                }, {}),
              };
            }
            return JSON.parse(serializedState);
          } catch (e) {
            console.error("Could not load state:", e);
            return {
              progress: MODULES.reduce((acc, module) => {
                acc[module.id] = { completed: false, score: 0, started: false };
                return acc;
              }, {}),
            };
          }
        };

        const saveState = (userId, state) => {
          try {
            const serializedState = JSON.stringify(state);
            localStorage.setItem(`assessmentState_${userId}`, serializedState);
          } catch (e) {
            console.error("Could not save state:", e);
          }
        };

        // --- QUIZ VIEW COMPONENT ---

        const QuizView = ({ module, onComplete, onBack, userId }) => { 
          // --- IMPORTANT CONFIGURATION: REPLACE THESE PLACEHOLDERS ---
          const SUPABASE_URL = "YOUR_SUPABASE_URL_HERE"; 
          const MOCK_AUTH_TOKEN = "MOCK_JWT_FOR_DEMO_REPLACE_ME";
          const SUPABASE_EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/assessment-api`;

          const [questions, setQuestions] = useState([]); 
          const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
          const [selectedAnswers, setSelectedAnswers] = useState({});
          const [timeLeft, setTimeLeft] = useState(TIME_LIMIT_SECONDS);
          const [quizState, setQuizState] = useState('loading'); 
          const [error, setError] = useState(null);

          const currentQuestion = questions[currentQuestionIndex];

          // 1. Timer Logic
          useEffect(() => {
            if (quizState !== 'ready') return;
            
            const timer = setInterval(() => {
              setTimeLeft(prevTime => {
                if (prevTime <= 1) {
                  clearInterval(timer);
                  handleSubmit(true); 
                  return 0;
                }
                return prevTime - 1;
              });
            }, 1000);

            return () => clearInterval(timer);
          }, [quizState]);
          
          // 2. Dynamic Question Loading 
          useEffect(() => {
            
            const fetchQuestions = async () => {
              setQuizState('loading');
              setError(null);

              if (SUPABASE_URL === "YOUR_SUPABASE_URL_HERE" || MOCK_AUTH_TOKEN === "MOCK_JWT_FOR_DEMO_REPLACE_ME") {
                  setError("Error: Please set your SUPABASE_URL and a valid MOCK_AUTH_TOKEN in QuizView to fetch real questions.");
                  setQuizState('error');
                  return;
              }
              
              try {
                  const response = await fetch(SUPABASE_EDGE_FUNCTION_URL, {
                      method: 'POST',
                      headers: { 
                          'Content-Type': 'application/json',
                          'Authorization': `Bearer ${MOCK_AUTH_TOKEN}`, 
                      },
                      body: JSON.stringify({ 
                          action: 'generate_questions', 
                          topic: module.topic, 
                          count: QUESTIONS_PER_MODULE 
                      }),
                  });

                  if (!response.ok) {
                      const errorData = await response.json();
                      throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                  }
                  
                  const fetchedQuestions = await response.json();
                  
                  if (!Array.isArray(fetchedQuestions) || fetchedQuestions.length === 0) {
                      throw new Error("AI returned zero or invalid questions.");
                  }
                  
                  setQuestions(fetchedQuestions);
                  setCurrentQuestionIndex(0); 
                  setSelectedAnswers({}); 
                  setTimeLeft(TIME_LIMIT_SECONDS); 
                  setQuizState('ready');

              } catch (e) {
                  console.error("Failed to fetch questions:", e);
                  setError(`Could not load quiz: ${e.message}. Check Supabase URL, token, and Edge Function logs.`);
                  setQuizState('error');
              }
            };

            fetchQuestions();
          }, [module.topic]); 

          const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          };

          const handleAnswerSelect = (optionIndex) => {
            setSelectedAnswers(prev => ({
              ...prev,
              [currentQuestion.id]: optionIndex
            }));
          };

          const handleNext = () => {
            if (currentQuestionIndex < questions.length - 1) {
              setCurrentQuestionIndex(prev => prev + 1);
            }
          };

          const handlePrevious = () => {
            if (currentQuestionIndex > 0) {
              setCurrentQuestionIndex(prev => prev - 1);
            }
          };

          const handleSubmit = async (isTimedOut = false) => { 
            setQuizState('submitting');
            let correctCount = 0;
            
            // MOCK SCORING LOGIC: Assumes index 0 is always correct for demonstration
            questions.forEach(q => {
                const selectedIndex = selectedAnswers[q.id];
                if (selectedIndex === 0) { 
                    correctCount++;
                }
            });

            const finalScore = Math.round((correctCount / QUESTIONS_PER_MODULE) * 100);

            try {
                // Submission LOGIC to Supabase 
                const submissionResponse = await fetch(SUPABASE_EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MOCK_AUTH_TOKEN}`, 
                    },
                    body: JSON.stringify({
                        action: 'submit_assessment',
                        moduleId: module.id,
                        score: finalScore,
                    }),
                });

                if (!submissionResponse.ok) {
                    const errorData = await submissionResponse.json();
                    throw new Error(errorData.error || `Submission failed with status ${submissionResponse.status}`);
                }

                onComplete(finalScore); 
                
            } catch (e) {
                console.error("Assessment submission failed:", e);
                setError(`Failed to save results: ${e.message}. The score has not been saved in Supabase.`);
                setQuizState('ready'); 
            }
          };

          if (quizState === 'error') {
             return (
                <div className="bg-red-50 border border-red-400 text-red-700 p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <h2 className="text-xl font-bold">Failed to Load Quiz</h2>
                    <p className="mt-2">{error}</p>
                    <button
                        onClick={onBack}
                        className="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                    >
                        Back to Dashboard
                    </button>
                </div>
             );
          }

          if (quizState === 'loading' || (quizState === 'ready' && questions.length === 0)) {
            return (
              <div className="flex items-center justify-center p-12 bg-white rounded-xl shadow-lg h-96">
                <div className="text-center">
                  <svg className="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <p className="mt-4 text-gray-700">Generating {QUESTIONS_PER_MODULE} questions for {module.name} using Perplexity AI...</p>
                </div>
              </div>
            );
          }


          return (
            <div className="bg-white p-6 md:p-8 rounded-xl shadow-2xl max-w-4xl mx-auto">
              <header className="mb-6 border-b pb-4 flex justify-between items-center">
                <h2 className="text-2xl font-bold text-indigo-700">{module.name}</h2>
                <div className={`text-lg font-mono px-3 py-1 rounded-full ${timeLeft < 60 ? 'bg-red-100 text-red-600' : 'bg-indigo-100 text-indigo-600'}`}>
                  Time Left: {formatTime(timeLeft)}
                </div>
              </header>
              
              {error && <div className="p-3 mb-4 text-red-700 bg-red-100 rounded-lg">{error}</div>}

              <div className="text-lg mb-6">
                <p className="font-semibold text-gray-800">Question {currentQuestionIndex + 1} of {questions.length}</p>
                <p className="mt-2 p-4 bg-gray-50 rounded-lg border">{currentQuestion.question}</p>
              </div>

              <div className="space-y-3 mb-8">
                {currentQuestion.options.map((option, index) => (
                  <button
                    key={index}
                    onClick={() => handleAnswerSelect(index)}
                    className={`w-full text-left p-3 rounded-lg border transition-all duration-200 
                      ${selectedAnswers[currentQuestion.id] === index
                        ? 'bg-indigo-500 text-white shadow-md border-indigo-600'
                        : 'bg-white text-gray-800 hover:bg-indigo-50 border-gray-200'
                      }`}
                    disabled={quizState === 'submitting'}
                  >
                    <span className="font-medium mr-2">{String.fromCharCode(65 + index)}.</span>
                    {option}
                  </button>
                ))}
              </div>

              <footer className="flex justify-between items-center border-t pt-4">
                <button
                  onClick={handlePrevious}
                  disabled={currentQuestionIndex === 0 || quizState === 'submitting'}
                  className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 disabled:opacity-50 transition-colors"
                >
                  &larr; Previous
                </button>
                
                <div className="flex space-x-2">
                    <button
                        onClick={onBack}
                        disabled={quizState === 'submitting'}
                        className="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors"
                    >
                        End Quiz
                    </button>
                    
                    {currentQuestionIndex === questions.length - 1 ? (
                        <button
                            onClick={() => handleSubmit()}
                            disabled={quizState === 'submitting'}
                            className="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold shadow-md hover:bg-green-600 transition-colors disabled:opacity-50"
                        >
                            {quizState === 'submitting' ? 'Submitting Score...' : 'Submit Assessment'}
                        </button>
                    ) : (
                        <button
                            onClick={handleNext}
                            disabled={quizState === 'submitting'}
                            className="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 disabled:opacity-50 transition-colors"
                        >
                            Next &rarr;
                        </button>
                    )}
                </div>
              </footer>
            </div>
          );
        };


        // --- MAIN APP COMPONENT ---

        const App = () => {
          const [currentUserId, setCurrentUserId] = useState('user_keshav');
          const [appState, setAppState] = useState(() => loadState('user_keshav'));
          const [currentView, setCurrentView] = useState(null); 

          useEffect(() => {
            setAppState(loadState(currentUserId));
            setCurrentView(null);
          }, [currentUserId]);

          useEffect(() => {
            saveState(currentUserId, appState);
          }, [appState, currentUserId]);

          const handleStartQuiz = (moduleId) => {
            setCurrentView(moduleId);
            setAppState(prev => ({
                ...prev,
                progress: {
                    ...prev.progress,
                    [moduleId]: { ...prev.progress[moduleId], started: true }
                }
            }));
          };

          const handleQuizComplete = (score) => {
            const moduleId = currentView;
            setAppState(prev => ({
              ...prev,
              progress: {
                [moduleId]: { completed: true, score: score, started: true },
                ...prev.progress 
              }
            }));
            setCurrentView(null); 
          };
          
          const handleBackToDashboard = () => {
            setCurrentView(null);
          };

          const totalModules = MODULES.length;
          const completedModules = MODULES.filter(m => appState.progress[m.id]?.completed).length;
          const isAssessmentComplete = completedModules === totalModules;
          
          const mentorEmail = MOCK_USERS['user_admin'].email;

          if (currentView) {
            const module = MODULES.find(m => m.id === currentView);
            return <QuizView 
                     module={module} 
                     onComplete={handleQuizComplete} 
                     onBack={handleBackToDashboard}
                     userId={currentUserId}
                   />;
          }
          
          return (
            <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans">
              
              {/* User Switcher */}
              <div className="fixed top-2 right-4 z-10 bg-white p-2 rounded-lg shadow-lg border border-indigo-100 flex items-center space-x-2">
                <label htmlFor="user-switcher" className="text-sm font-medium text-gray-700">
                  Current User (Mock Login):
                </label>
                <select
                  id="user-switcher"
                  value={currentUserId}
                  onChange={(e) => setCurrentUserId(e.target.value)}
                  className="p-1 border border-gray-300 rounded-md text-sm bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500"
                >
                  {Object.entries(MOCK_USERS).map(([id, user]) => (
                    <option key={id} value={id}>
                      {user.name}
                    </option>
                  ))}
                </select>
              </div>

              <header className="text-center mb-10 pt-10">
                <h1 className="text-4xl font-extrabold text-indigo-700 tracking-tight">
                  Skills Challenge Dashboard
                </h1>
                <p className="mt-2 text-xl text-gray-500">
                  Welcome, {MOCK_USERS[currentUserId].name}. Complete the modules below to unlock your final report.
                </p>
                
                {/* Progress Bar */}
                <div className="mt-6 w-full max-w-2xl mx-auto">
                  <div className="h-3 bg-gray-200 rounded-full">
                    <div
                      className="h-3 bg-indigo-500 rounded-full transition-all duration-500 ease-out"
                      style={{ width: `${(completedModules / totalModules) * 100}%` }}
                    ></div>
                  </div>
                  <p className="mt-1 text-sm font-medium text-gray-600">{completedModules} of {totalModules} Modules Completed</p>
                </div>
              </header>

              {/* Module Cards */}
              <div className="max-w-4xl mx-auto space-y-6">
                {MODULES.map(module => {
                  const status = appState.progress[module.id];
                  const isCompleted = status.completed;
                  const isDisabled = isCompleted; 
                  const buttonText = isCompleted ? `Review Score: ${status.score}%` : 'Start Assessment';
                  
                  return (
                    <div 
                      key={module.id} 
                      className={`flex flex-col md:flex-row items-start md:items-center justify-between p-6 rounded-xl shadow-lg transition-all duration-300 
                        ${isCompleted ? 'bg-green-50 border-green-300 border-2' : 'bg-white border border-gray-200 hover:shadow-xl'}
                      `}
                    >
                      <div>
                        <h3 className={`text-xl font-bold ${isCompleted ? 'text-green-800' : 'text-indigo-600'}`}>
                          {module.name}
                        </h3>
                        <p className="mt-1 text-gray-600">{module.topic}</p>
                      </div>

                      <button
                        onClick={() => handleStartQuiz(module.id)}
                        disabled={isDisabled} 
                        className={`mt-4 md:mt-0 px-6 py-2 font-semibold rounded-lg transition-colors duration-200 disabled:opacity-50 
                          ${isCompleted
                            ? 'bg-green-500 text-white hover:bg-green-600'
                            : 'bg-indigo-500 text-white hover:bg-indigo-600'
                          }
                        `}
                      >
                        {buttonText}
                      </button>
                    </div>
                  );
                })}
              </div>

              {/* Completion/Mentor Section */}
              <div className="mt-12 max-w-4xl mx-auto p-6 text-center bg-white rounded-xl shadow-2xl border-t-4 border-indigo-500">
                {isAssessmentComplete ? (
                  <>
                    <h2 className="text-2xl font-bold text-green-700">
                      Congratulations! Assessment Complete.
                    </h2>
                    <p className="mt-3 text-lg text-gray-700">
                      Your final report is ready. Please click below to view your results.
                    </p>
                    <button
                      className="mt-4 px-8 py-3 bg-indigo-500 text-white text-lg font-bold rounded-xl shadow-lg hover:bg-indigo-600 transition-colors"
                    >
                      Get Final Report
                    </button>
                  </>
                ) : (
                   <h2 className="text-2xl font-bold text-indigo-700">
                     Complete all modules to unlock your Final Report.
                   </h2>
                )}

                {/* Mentor Contact (Permanently Visible) */}
                <div className="mt-6 pt-4 border-t border-gray-200">
                    <h3 className="text-lg font-semibold text-gray-800">Need Guidance?</h3>
                    <p className="text-sm text-gray-600">
                        Contact your mentor for next steps or support on your journey.
                    </p>
                    <a 
                        href={`mailto:${mentorEmail}`} 
                        className="mt-2 inline-block px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors"
                    >
                        Contact Your Mentor: {mentorEmail}
                    </a>
                </div>
              </div>
            </div>
          );
        };

        // Render the main App component
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
