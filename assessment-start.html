<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Career Launchpad: Skills Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 2.5rem;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .module-button {
            transition: all 0.2s ease-in-out;
            background-image: linear-gradient(135deg, var(--tw-gradient-stops));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .module-button:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        /* Ensure the disabled button has a visible, flat background */
        .module-button:disabled {
            cursor: not-allowed;
            opacity: 1; 
            background-image: none;
            background-color: #d1d5db; /* Light gray for completed */
            box-shadow: none;
        }
        /* Style for guaranteed text visibility on active buttons */
        .active-text-shadow {
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }

        .quiz-container {
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .modal {
            transition: opacity 0.2s ease-in-out;
        }
        .radio-option {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: background-color 0.15s, border-color 0.15s;
        }
        .radio-option:hover {
            background-color: #f3f4f6;
        }
        .radio-option.selected {
            background-color: #e0f2fe; /* Tailwind blue-100 */
            border-color: #0b70d7; /* Tailwind blue-600 */
            box-shadow: 0 0 5px rgba(14, 165, 233, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-start pt-8">

    <div id="app" class="container-card w-full">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Payment Modal Structure (Hidden by default) -->
    <div id="payment-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center opacity-0 pointer-events-none z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-4 border-b pb-3 text-center">Unlock Your Future</h2>
            <p class="text-gray-600 mb-6 text-center">Congratulations! You've mastered the challenge. Pay **₹99** to receive your full performance report, detailed scores, and personalized feedback from our mentors.</p>
            
            <div class="space-y-4">
                <p class="font-bold text-2xl text-green-600 text-center border-b pb-2">Total Payable: ₹99</p>
                <div class="border border-green-200 p-4 rounded-xl bg-green-50 shadow-inner">
                    <p class="font-medium text-lg text-green-800 mb-3">Secure Payment Options:</p>
                    <button class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-700 transition duration-150 shadow-lg transform hover:scale-[1.01]">
                        Pay with UPI (Recommended)
                    </button>
                    <button class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold mt-3 hover:bg-gray-300 transition duration-150">
                        Credit/Debit Card / Net Banking
                    </button>
                </div>
            </div>

            <div class="flex justify-center mt-6">
                <button onclick="closePaymentModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition duration-150">
                    Close Window
                </button>
            </div>
            <p class="text-xs text-center text-gray-400 mt-4">Note: This is a simulated payment gateway for demonstration purposes only.</p>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        // Placeholder for the real API endpoint. This will be replaced by the environment URL if available.
        const PLACEHOLDER_API_ENDPOINT = 'https://[Your-Supabase-Project-Ref].supabase.co/functions/v1/assessment-api'; 
        
        const QUESTIONS_PER_MODULE = 15; 
        const TIME_LIMIT_MINUTES = 15;  
        const MODULES = {
            'technical': 'Technical Fundamentals',
            'aptitude': 'Aptitude and Reasoning',
            'behavioural': 'Behavioural Assessment'
        };

        let userToken = null;
        let userEmail = null;
        let currentModule = null;
        let questions = [];
        let answers = {};
        let timerInterval = null; // Timer variable for the quiz
        let API_ENDPOINT = PLACEHOLDER_API_ENDPOINT; // Initialize with placeholder

        // --- CONSTANTS ---
        const MENTOR_EMAIL = 'ready4industry@gmail.com';
        
        // --- UTILITY FUNCTIONS ---
        
        // Function to parse the fragment for the token (Simulates Supabase Auth Redirect)
        function parseFragment() {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const token = params.get('access_token');
            const email = params.get('email') || 'Guest User';
            
            if (token) {
                userToken = token;
                userEmail = email;
            } else {
                // Mock email for preview mode testing if no token is present
                userEmail = 'keshav.karn@gmail.com'; 
            }
        }
        
        // --- MOCK DATA GENERATOR (For testing when API is unavailable) ---
        function generateMockQuestions(count, topic) {
            const mockQuestions = [];
            for (let i = 1; i <= count; i++) {
                mockQuestions.push({
                    id: `q-${topic}-${i}`,
                    question: `What is the key principle of ${topic} question number ${i}?`,
                    options: [
                        `Option A for question ${i}`,
                        `Option B for question ${i}`,
                        `Option C for question ${i}`,
                        `Option D for question ${i}`
                    ],
                    // In a real app, the correct answer would not be sent to the frontend
                    correctAnswer: `Option C for question ${i}` 
                });
            }
            return mockQuestions;
        }

        // --- TIMER LOGIC ---
        function startTimer() {
            cleanupTimer(); // Clear any existing timer
            let timeRemaining = TIME_LIMIT_MINUTES * 60;
            updateTimerDisplay(timeRemaining);

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay(timeRemaining);

                if (timeRemaining <= 0) {
                    cleanupTimer();
                    timeExpired();
                }
            }, 1000);
        }

        function cleanupTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateTimerDisplay(seconds) {
            const timerElement = document.getElementById('timer-display');
            if (!timerElement) return;

            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            timerElement.textContent = display;

            // Highlight timer red when under 1 minute
            if (seconds <= 60) {
                timerElement.classList.add('text-red-600', 'font-extrabold');
            } else {
                timerElement.classList.remove('text-red-600', 'font-extrabold');
            }
        }

        function timeExpired() {
            const quizMessage = document.getElementById('quiz-message');
            if (quizMessage) {
                 quizMessage.innerHTML = "<span class='font-bold text-red-600'>Time Expired!</span> Submitting your current answers automatically...";
            }
           
            // Disable further interaction
            document.querySelectorAll('.radio-option').forEach(el => el.onclick = null);
            const submitButton = document.getElementById('submit-button');
            if (submitButton) submitButton.disabled = true;

            // Automatically submit after a short delay
            setTimeout(() => {
                submitAssessment(true); // true means forced submission
            }, 1500);
        }
        
        // --- DASHBOARD/STATE MANAGEMENT ---

        function getModuleState() {
            try {
                const state = JSON.parse(localStorage.getItem('assessmentState') || '{}');
                return state;
            } catch (e) {
                console.error("Error loading assessment state from localStorage:", e);
                return {};
            }
        }

        function setModuleCompleted(moduleKey) {
            const state = getModuleState();
            state[moduleKey] = true;
            localStorage.setItem('assessmentState', JSON.stringify(state));
            currentModule = null; // Exit quiz view
            render();
        }

        function displayDashboard() {
            const app = document.getElementById('app');
            const state = getModuleState();
            
            const allCompleted = Object.keys(MODULES).every(key => state[key]);

            let moduleHtml = Object.entries(MODULES).map(([key, name]) => {
                const isCompleted = state[key] === true;
                const disabled = isCompleted ? 'disabled' : '';
                const statusText = isCompleted ? 'Completed' : 'Start Challenge';
                
                let colorClass; // Tailwind gradient classes
                let textColorClass; // Tailwind text color class

                if (isCompleted) {
                    // Completed module: light gray background, dark text
                    colorClass = ''; 
                    textColorClass = 'text-gray-800';
                } else {
                    // Active module: specific gradient, white text
                    textColorClass = 'text-white';
                    if (key === 'technical') {
                        colorClass = 'from-blue-500 to-indigo-600';
                    } else if (key === 'aptitude') {
                        colorClass = 'from-green-500 to-teal-600';
                    } else if (key === 'behavioural') {
                        colorClass = 'from-purple-500 to-pink-600';
                    }
                }
                
                // Active modules get the text shadow CSS class for visibility
                const textShadowClass = isCompleted ? '' : 'active-text-shadow';
                // Status pill styling
                const statusPillClass = isCompleted ? 'bg-gray-400 text-gray-800' : 'bg-white bg-opacity-20 text-white';

                return `
                    <button 
                        onclick="startAssessment('${key}', '${name}')" 
                        class="module-button w-full text-center p-6 rounded-xl font-extrabold text-lg shadow-lg ${colorClass} ${disabled} ${textColorClass}"
                        style="--tw-gradient-stops: var(--tw-gradient-from) var(--tw-gradient-to);"
                        ${disabled}
                    >
                        <span class="${textShadowClass} text-xl">${name}</span>
                        <span class="text-sm font-semibold tracking-wider py-1 px-3 rounded-full ${statusPillClass}">${statusText}</span>
                    </button>
                `;
            }).join('');
            
            // --- Contact Mentor Button ---
            const mentorButton = `
                <a href="mailto:${MENTOR_EMAIL}" class="w-full block mt-8">
                    <button class="w-full p-4 bg-gray-100 text-gray-800 rounded-xl font-semibold hover:bg-gray-200 transition duration-200 shadow-lg border border-gray-200">
                        Need Guidance? Contact Your Mentor: <span class="text-indigo-600">${MENTOR_EMAIL}</span>
                    </button>
                </a>
            `;
            
            // --- Upbeat Welcome Section ---
            const welcomeSection = `
                <div class="bg-indigo-600 text-white p-6 rounded-xl mb-6 shadow-2xl">
                    <h1 class="text-3xl font-extrabold mb-1">Skills Challenge Dashboard</h1>
                    <p class="text-lg font-medium opacity-90">Welcome, ${userEmail}! Select a module to begin.</p>
                </div>
            `;

            app.innerHTML = `
                ${welcomeSection}
                
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-3">Assessment Modules:</h2>
                
                <div class="space-y-4">
                    ${moduleHtml}
                </div>
                
                ${allCompleted ? `
                    <div class="mt-8 p-6 bg-yellow-50 border-4 border-yellow-300 rounded-xl text-center shadow-2xl">
                        <p class="text-xl font-extrabold text-yellow-800 mb-4">Challenge Complete! Victory Achieved!</p>
                        <p class="text-md text-gray-700 mb-6">All modules are finished. Unlock your detailed performance report and personalized feedback now.</p>
                        <button 
                            onclick="showPaymentModal()" 
                            class="w-full md:w-3/5 px-8 py-3 bg-red-600 text-white rounded-lg font-extrabold text-lg hover:bg-red-700 transition duration-200 shadow-2xl transform hover:scale-[1.05]"
                        >
                            Get Final Result: Pay ₹99
                        </button>
                    </div>
                ` : mentorButton} 
            `;
        }

        // --- QUIZ VIEW AND INTERACTION ---

        function displayQuiz() {
            const app = document.getElementById('app');
            const topicName = MODULES[currentModule];
            
            const questionHtml = questions.map((q, qIndex) => {
                const optionsHtml = q.options.map((opt, oIndex) => {
                    const optionId = `q${qIndex}o${oIndex}`;
                    const isSelected = answers[q.id] === opt;
                    const selectedClass = isSelected ? 'selected' : '';

                    return `
                        <div 
                            class="radio-option ${selectedClass}"
                            onclick="handleOptionSelect('${q.id}', '${opt.replace(/'/g, "\\'")}')"
                            id="${optionId}"
                        >
                            <span class="font-medium text-gray-800">${String.fromCharCode(65 + oIndex)}.</span> ${opt}
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="quiz-container shadow-md">
                        <p class="font-semibold text-xl text-gray-900 mb-4">${qIndex + 1}. ${q.question}</p>
                        <div class="space-y-2">
                            ${optionsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            app.innerHTML = `
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h1 class="text-3xl font-bold text-gray-800">${topicName}</h1>
                    <div class="flex items-center space-x-3 p-3 bg-gray-100 rounded-lg shadow-inner">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span id="timer-display" class="text-2xl font-bold text-indigo-600">--:--</span>
                    </div>
                </div>
                
                <p class="text-lg text-gray-600 mb-6">You have ${TIME_LIMIT_MINUTES} minutes to answer all ${QUESTIONS_PER_MODULE} questions.</p>
                
                ${questionHtml}
                
                <div class="flex justify-between items-center mt-6 pt-4 border-t">
                    <button 
                        onclick="cleanupQuiz(); render();" 
                        class="px-6 py-3 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-200"
                    >
                        &larr; Exit Challenge
                    </button>
                    <button 
                        onclick="submitAssessment(false)" 
                        id="submit-button"
                        class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Submit Quiz
                    </button>
                </div>
                <div id="quiz-message" class="mt-4 text-sm text-red-600 font-medium"></div>
            `;
            // Start the timer when the quiz display is rendered
            startTimer();
            updateSubmitButtonState();
        }

        function handleOptionSelect(questionId, selectedOption) {
            answers[questionId] = selectedOption;
            // Re-render the quiz section to update selection visuals
            displayQuiz(); 
            updateSubmitButtonState();
        }
        
        function updateSubmitButtonState() {
            const submitButton = document.getElementById('submit-button');
            if (submitButton) {
                const answeredCount = Object.keys(answers).length;
                const requiredCount = questions.length;
                
                if (answeredCount === requiredCount) {
                    submitButton.disabled = false;
                    document.getElementById('quiz-message').textContent = 'All questions answered. Ready to submit!';
                    document.getElementById('quiz-message').classList.remove('text-red-600');
                    document.getElementById('quiz-message').classList.add('text-green-600');
                } else {
                    submitButton.disabled = true;
                    document.getElementById('quiz-message').textContent = `Please answer all ${requiredCount} questions before submitting. (${answeredCount}/${requiredCount} answered)`;
                    document.getElementById('quiz-message').classList.add('text-red-600');
                    document.getElementById('quiz-message').classList.remove('text-green-600');
                }
            }
        }
        
        function cleanupQuiz() {
            // Clears all state and the timer when leaving the quiz view (either by submit or exit)
            cleanupTimer();
            currentModule = null; 
            answers = {}; 
            questions = []; 
        }

        function submitAssessment(isForced = false) {
            const answeredCount = Object.keys(answers).length;
            if (!isForced && answeredCount !== questions.length) {
                document.getElementById('quiz-message').textContent = 'Please answer all questions before submitting.';
                return;
            }

            // In a real app, you would send answers to the backend (assessment-api) here.
            
            // Mark complete and clean up
            setModuleCompleted(currentModule);
            cleanupQuiz();
        }
        
        // --- API CALLS (MOCKED IF PLACEHOLDER IS USED) ---
        
        async function startAssessment(key, name) {
            currentModule = key;
            questions = [];
            answers = {};
            renderLoading(`Gearing up for the ${name} challenge (${QUESTIONS_PER_MODULE} questions)...`);

            // Check if the placeholder is still in use. If so, use mock data.
            if (API_ENDPOINT.includes('[Your-Supabase-Project-Ref]')) {
                console.warn("Using mock data because the API endpoint is a placeholder. Quiz flow can still be tested.");
                
                // Simulate network latency (2 seconds)
                setTimeout(() => {
                    questions = generateMockQuestions(QUESTIONS_PER_MODULE, name);
                    displayQuiz();
                }, 2000); 
                return; 
            }

            // --- REAL API CALL (ONLY EXECUTED IF API_ENDPOINT IS VALID) ---
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`,
                    },
                    body: JSON.stringify({
                        action: 'generate_questions',
                        topic: name,
                        count: QUESTIONS_PER_MODULE 
                    })
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(errorJson.error || 'Unknown server error');
                }

                const data = await response.json();
                
                if (data && Array.isArray(data) && data.length === QUESTIONS_PER_MODULE) {
                    questions = data;
                } else {
                     throw new Error(`AI returned an unexpected number of questions. Expected ${QUESTIONS_PER_MODULE}, got ${data.length || 0}.`);
                }
                
                displayQuiz();
                
            } catch (error) {
                renderError(`Failed to load questions for ${name}: ${error.message}`);
                console.error("Assessment Load Error:", error);
                // On error, revert to dashboard
                currentModule = null;
                setTimeout(render, 3000); 
            }
        }

        // --- VIEW RENDERING ---

        function renderLoading(message) {
             document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center p-16 text-gray-600">
                    <svg class="animate-spin h-10 w-10 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-xl font-medium">${message}</p>
                    <p class="text-sm mt-2 text-gray-500">Generating ${QUESTIONS_PER_MODULE} questions might take a moment...</p>
                </div>
            `;
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-md" role="alert">
                    <p class="font-bold">Error Loading Assessment</p>
                    <p>${message}</p>
                    <p class="text-sm mt-2">Returning to dashboard in 3 seconds...</p>
                </div>
            `;
        }
        
        function render() {
            if (!userToken && !userEmail) {
                // Should only happen in true unauthenticated state (not in the editor preview)
                document.getElementById('app').innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Core Concepts Check</h1>
                    <p class="text-xl text-red-600">No authentication token found. Please log in through the main page.</p>
                `;
            } else if (currentModule) {
                displayQuiz();
            } else {
                displayDashboard();
            }
        }
        
        // --- PAYMENT MODAL FUNCTIONS ---

        function showPaymentModal() {
            const modal = document.getElementById('payment-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            modal.querySelector('.transform').classList.remove('scale-95');
        }

        function closePaymentModal() {
            const modal = document.getElementById('payment-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.transform').classList.add('scale-95');
        }


        // --- INITIALIZATION ---
        
        // Try to get the real Supabase URL from the environment
        if (typeof __supabase_url !== 'undefined' && __supabase_url && !__supabase_url.includes('[Your-Supabase-Project-Ref]')) {
             const endpoint_prefix = __supabase_url.endsWith('/') ? __supabase_url.slice(0, -1) : __supabase_url;
             API_ENDPOINT = `${endpoint_prefix}/functions/v1/assessment-api`;
        } else {
            console.warn("API URL not set. Using mock assessment data for testing purposes.");
        }
        
        parseFragment();
        render();

        // Attach event listener for closing modal via ESC key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePaymentModal();
            }
        });
    </script>
</body>
</html>
