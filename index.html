<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B.Tech Assessment Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Simple utility for hiding screens */
        .hidden-screen { display: none; }
        /* Custom styles for table/history */
        .history-table th { background-color: #f1f5f9; text-align: left; padding: 12px 16px; border-bottom: 2px solid #e2e8f0; }
        .history-table td { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; }
        .history-table tr:hover { background-color: #fafafa; }
        /* Input focus style */
        input:focus { border-color: #4f46e5; box-shadow: 0 0 0 1px #4f46e5; }
    </style>
    <!-- Supabase JS CDN for client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">

    <!-- Main Application Container -->
    <div class="w-full max-w-4xl bg-white p-6 md:p-10 rounded-xl shadow-2xl space-y-8 mt-10">

        <!-- Header / Status -->
        <header class="text-center space-y-2">
            <h1 class="text-4xl font-extrabold text-indigo-700">Student Assessment Hub</h1>
            <p id="status-message" class="text-sm text-gray-500 font-medium h-6">
                Please sign in to view assessments.
            </p>
            <div id="user-display" class="hidden text-sm text-gray-700 p-2 bg-indigo-50 rounded-lg flex justify-between items-center">
                <p>Welcome, <span id="user-email-display" class="font-semibold"></span>!</p>
                <button id="sign-out" class="py-1 px-3 text-xs bg-indigo-200 text-indigo-800 font-medium rounded-lg hover:bg-indigo-300 transition duration-150">Sign Out</button>
            </div>
        </header>

        <!-- Screens Container -->
        <main id="screens-container">
            
            <!-- 1. LOGIN SCREEN -->
            <section id="login-screen" class="space-y-6 flex flex-col items-center justify-center min-h-[300px]">
                <div class="text-center space-y-2">
                    <h2 class="text-2xl font-bold text-gray-800">Start Your Assessment Journey</h2>
                    <p class="text-gray-600">Use your Google Profile to register and proceed.</p>
                </div>
                
                <!-- Google Sign-In Button -->
                <button id="google-sign-in"
                    class="w-full max-w-xs flex items-center justify-center px-6 py-3 border border-gray-300 rounded-xl shadow-md text-base font-semibold text-gray-700 bg-white hover:bg-indigo-50 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.007 8-11.303 8c-6.627 0-12-5.373-12-12c0-6.627 5.373-12 12-12c3.059 0 5.842 1.158 7.96 3.03l5.657-5.657C34.046 6.053 29.043 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path>
                        <path fill="#FF3D00" d="M6.306 14.693l6.577 4.816C14.655 15.108 18.9 12 24 12c5.361 0 9.845 3.32 11.83 8.083l6.096-4.472C38.078 8.448 31.424 4 24 4C16.634 4 10.05 7.425 6.306 12.693z"></path>
                        <path fill="#4CAF50" d="M24 44c5.21 0 9.873-1.657 13.886-4.832l-6.208-4.706C29.613 36.88 27.054 37 24 37c-5.228 0-9.882-3.351-11.841-8.083L5.035 34.482C8.751 39.52 15.9 44 24 44z"></path>
                        <path fill="#1976D2" d="M43.611 20.083c0-1.341-.138-2.65-.389-3.917H24v8h11.303a12.043 12.043 0 00-1.649 4.657H24v7.417c8.1 0 14.757-5.048 17.57-12.215c.251-1.267.389-2.576.389-3.917z"></path>
                    </svg>
                    Sign in with Google
                </button>
                <p id="supabase-error" class="text-xs text-red-500 hidden">Supabase initialization failed. Check console for details.</p>
            </section>

            <!-- 2. ASSESSMENT DASHBOARD SCREEN (Landing Page / LMS Sections) -->
            <section id="assessment-dashboard" class="hidden-screen space-y-8">
                <div class="border-b pb-4">
                    <h2 class="text-3xl font-bold text-gray-800">Select Your Assessment (All Free)</h2>
                    <p class="text-gray-600 text-sm mt-1">Choose one of the three 20-question, AI-generated tests below.</p>
                </div>
                
                <!-- Assessment Cards (The 3 Sections) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                    <!-- 1. Technical Assessment Card (FREE) -->
                    <div class="bg-white border-2 border-green-400 rounded-xl p-6 shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1">
                        <h3 class="text-xl font-bold text-green-600 mb-2">1. Technical Fundamentals</h3>
                        <p class="text-sm text-gray-600 mb-4">Core B.Tech syllabus topics (DS, OS, DBMS, Networking).</p>
                        <button id="start-technical" class="w-full py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150">
                            Start Assessment
                        </button>
                    </div>

                    <!-- 2. Aptitude Test Card (FREE) -->
                    <div class="bg-white border-2 border-indigo-400 rounded-xl p-6 shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1">
                        <h3 class="text-xl font-bold text-indigo-600 mb-2">2. Aptitude & Reasoning</h3>
                        <p class="text-sm text-gray-600 mb-4">Logical reasoning, quantitative analysis, and data interpretation.</p>
                        <button id="start-aptitude" class="w-full py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150">
                            Start Assessment
                        </button>
                    </div>

                    <!-- 3. Behavioral Skills Card (FREE) -->
                    <div class="bg-white border-2 border-red-400 rounded-xl p-6 shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1">
                        <h3 class="text-xl font-bold text-red-600 mb-2">3. Behavioral Skills</h3>
                        <p class="text-sm text-gray-600 mb-4">Assesses communication, teamwork, and problem-solving scenarios.</p>
                        <button id="start-behavioral" class="w-full py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150">
                            Start Assessment
                        </button>
                    </div>
                </div>

                <!-- Assessment History (LMS Feature) -->
                <div class="pt-6 border-t">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Your Assessment History</h3>
                    <div id="history-loading" class="text-gray-500 text-center py-4">
                         <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-400 inline-block mr-2"></div> Loading history...
                    </div>
                    <div id="assessment-history" class="overflow-x-auto shadow-md rounded-lg">
                        <!-- History table will be injected here -->
                    </div>
                </div>

            </section>

            <!-- 3. ASSESSMENT IN PROGRESS SCREEN -->
            <section id="assessment-in-progress" class="hidden-screen p-6 bg-indigo-50 border border-indigo-200 rounded-xl">
                 <h2 id="quiz-title" class="text-2xl font-bold text-indigo-700 mb-4"></h2>
                 <div id="loader" class="flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-500"></div>
                    <p id="assessment-status" class="text-sm text-indigo-600">Please wait while the AI prepares your 20-question test.</p>
                 </div>
                 <form id="quiz-form">
                    <div id="quiz-content" class="mt-6">
                        <!-- Quiz questions will be rendered here -->
                    </div>
                 </form>
            </section>

             <!-- 4. ASSESSMENT RESULTS SCREEN (Score hidden, CTA shown) -->
            <section id="assessment-results" class="hidden-screen p-6 bg-white border border-gray-200 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-indigo-700 mb-4">Assessment Complete!</h2>
                <div class="space-y-6">
                    <p class="text-xl text-gray-700 text-center">Thank you for taking the <span id="results-topic" class="font-bold text-indigo-600"></span> assessment.</p>
                    
                    <!-- New CTA Box - Replacing the score display -->
                    <div class="p-6 bg-yellow-50 border-2 border-yellow-300 rounded-xl shadow-md space-y-3 text-center">
                        <h3 class="text-2xl font-extrabold text-yellow-800">Unlock Your Detailed Analysis</h3>
                        <p class="text-gray-700 text-lg font-medium">
                            Your performance is recorded. To receive a detailed breakdown of your results, including:
                        </p>
                        <ul class="text-left list-disc list-inside text-gray-600 space-y-1 max-w-sm mx-auto">
                            <li>Your exact score and ranking.</li>
                            <li>Specific areas that need improvement.</li>
                            <li>Personalized study recommendations.</li>
                        </ul>
                        <p class="text-2xl font-bold text-red-600 pt-2">
                            Pay ₹200 for Analysis
                        </p>
                        <p class="text-sm text-gray-500">
                            Please contact the administrator at <a href="mailto:admin@example.com" class="text-indigo-500 hover:underline font-semibold">admin@example.com</a> to finalize payment and receive your report.
                        </p>
                    </div>

                    <button id="results-back-to-dashboard" class="w-full py-3 bg-gray-700 text-white font-semibold rounded-xl hover:bg-gray-800 transition duration-150 mt-4">
                        Back to Assessments
                    </button>
                </div>
            </section>
        </main>

    </div>

    <!-- Supabase and LLM Logic -->
    <script type="module">
        // --- 1. SUPABASE CONFIGURATION (Using provided credentials) ---
        const SUPABASE_URL = 'https://glskwkzzkhhwftzddqmo.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdsc2t3a3p6a2hod2Z0emRkcW1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MDg2OTEsImV4cCI6MjA3NTA4NDY5MX0.g3XQyV6T_xfBCSOb0X0X1idGNpD0zEBhMhX8RZ1PLH5R8';
        
        let supabase;
        try {
            // Uses the imported createClient function from the CDN
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Supabase initialization failed:", error);
            document.getElementById('supabase-error').classList.remove('hidden');
        }

        // --- 2. UI ELEMENT REFERENCES ---
        const statusMessage = document.getElementById('status-message');
        const loginScreen = document.getElementById('login-screen');
        const assessmentDashboard = document.getElementById('assessment-dashboard');
        const assessmentInProgress = document.getElementById('assessment-in-progress');
        const assessmentResults = document.getElementById('assessment-results');
        const userEmailDisplay = document.getElementById('user-email-display');
        const userDisplay = document.getElementById('user-display');
        const googleSignInButton = document.getElementById('google-sign-in');
        const signOutButton = document.getElementById('sign-out');
        const quizForm = document.getElementById('quiz-form');
        const quizTitle = document.getElementById('quiz-title');
        const historyLoading = document.getElementById('history-loading');
        const assessmentHistoryDiv = document.getElementById('assessment-history');


        let currentQuizData = []; // Store the generated questions and answers
        let currentTopic = ''; // Store the current topic being assessed

        /**
         * Switches the active screen based on the user's logged-in status.
         * @param {object | null} user - The Supabase user object or null.
         * @param {string} activeScreenId - The ID of the screen to show ('login', 'dashboard', 'quiz', 'results').
         */
        const renderScreen = (user, activeScreenId = 'dashboard') => {
            const screens = {
                'login': loginScreen,
                'dashboard': assessmentDashboard,
                'quiz': assessmentInProgress,
                'results': assessmentResults,
            };

            // Hide all screens initially
            Object.values(screens).forEach(screen => screen.classList.add('hidden-screen'));

            // Check if the user is authenticated (Supabase user object exists)
            const isAuthenticated = user && user.id;

            // Update Header Display
            userDisplay.classList.add('hidden');
            
            if (isAuthenticated) {
                userEmailDisplay.textContent = user.email || 'N/A';
                userDisplay.classList.remove('hidden');
                
                // Show the requested screen
                screens[activeScreenId].classList.remove('hidden-screen');
                
                let message = 'Ready to begin your assessment.';

                if (activeScreenId === 'quiz') {
                    message = 'Assessment is loading...';
                } else if (activeScreenId === 'results') {
                    message = 'Assessment complete. See analysis options below.';
                } else if (activeScreenId === 'dashboard') {
                    loadAssessmentHistory(user.id); // Load history on dashboard view
                }

                statusMessage.textContent = message;

            } else {
                // Not signed in, show login
                screens['login'].classList.remove('hidden-screen');
                statusMessage.textContent = 'Please sign in to view assessments.';
            }
        };


        // --- 3. SUPABASE AUTH HANDLERS ---
        
        const signInWithGoogle = async () => {
            if (!supabase) return;
            statusMessage.textContent = 'Redirecting to Google for sign-in...';
            try {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: window.location.origin },
                });
                if (error) throw error;
            } catch (error) {
                console.error("Sign-in redirect error:", error);
                statusMessage.textContent = `Sign-in failed: ${error.message}`;
            }
        };

        const handleSignOut = async () => {
            if (!supabase) return;
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                statusMessage.textContent = 'Signed out. Thank you for visiting.';
            } catch (error) {
                console.error("Sign-out error:", error);
                statusMessage.textContent = `Sign-out failed: ${error.message}`;
            }
        };

        // --- 4. SUPABASE DATA PERSISTENCE (LMS Feature) ---

        /**
         * Saves the assessment result to the Supabase database.
         * The price is set to the cost of the Detailed Analysis (200 Rs).
         */
        async function saveAssessmentResult(userId, topic, score, maxScore) {
            if (!supabase || !userId) {
                console.error("Supabase not initialized or user not logged in.");
                return;
            }
            
            const ANALYSIS_PRICE = 200; // Cost for detailed analysis report
            
            // NOTE: 'assessments' is the table you need to create in your Supabase project.
            const { data, error } = await supabase
                .from('assessments') 
                .insert([
                    // Score is saved privately to the database (for the owner)
                    { user_id: userId, topic: topic, score: score, max_score: maxScore, price: ANALYSIS_PRICE }
                ]);

            if (error) {
                console.error("Error saving assessment result:", error);
            } else {
                console.log("Assessment result saved successfully:", data);
            }
        }

        /**
         * Loads and displays the user's past assessment history.
         * Score is hidden, Analysis CTA is shown.
         */
        async function loadAssessmentHistory(userId) {
            if (!supabase || !userId) return;

            historyLoading.classList.remove('hidden');
            assessmentHistoryDiv.innerHTML = '';

            const { data: history, error } = await supabase
                .from('assessments')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false });

            historyLoading.classList.add('hidden');

            if (error) {
                console.error("Error loading history:", error);
                assessmentHistoryDiv.innerHTML = `<p class="text-red-500 text-center">Could not load history. Have you created the 'assessments' table (with 'price' column) in Supabase?</p>`;
                return;
            }

            if (history.length === 0) {
                assessmentHistoryDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No assessments completed yet. Start a test above!</p>';
                return;
            }

            // Render the history table
            let tableHtml = `
                <table class="history-table min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Assessment Topic</th>
                            <th>Status</th>
                            <th>Analysis Cost</th>
                            <th class="rounded-tr-lg">Date Completed</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            history.forEach(item => {
                const date = new Date(item.created_at).toLocaleDateString();
                const time = new Date(item.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Score is not displayed, only status
                const statusText = '<span class="text-green-600 font-medium">Completed</span>';
                
                // Display the analysis cost
                const analysisCostText = item.price > 0 ? `₹${item.price}` : 'FREE';

                tableHtml += `
                    <tr>
                        <td class="font-medium text-gray-800">${item.topic}</td>
                        <td class="text-gray-600">${statusText}</td>
                        <td class="text-red-600 font-semibold">${analysisCostText}</td>
                        <td class="text-gray-500 text-sm">${date} at ${time}</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;
            assessmentHistoryDiv.innerHTML = tableHtml;
        }


        // --- 5. LLM QUESTION GENERATION LOGIC (Unchanged) ---
        
        // Define the JSON schema for 20 questions
        const quizSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "question": { "type": "STRING", "description": "The main text of the multiple-choice question." },
                    "options": { 
                        "type": "OBJECT", 
                        "properties": {
                            "A": { "type": "STRING" },
                            "B": { "type": "STRING" },
                            "C": { "type": "STRING" },
                            "D": { "type": "STRING" },
                        },
                        "required": ["A", "B", "C", "D"],
                        "description": "The four options for the multiple-choice question."
                    },
                    "answerKey": { 
                        "type": "STRING", 
                        "description": "The correct option key (A, B, C, or D)."
                    }
                },
                "required": ["question", "options", "answerKey"]
            }
        };

        // LLM API call function with exponential backoff
        async function generateQuiz(topic, attempts = 0) {
            currentTopic = topic;
            const session = await supabase.auth.getSession();
            const user = session.data.session?.user || null;

            if (!user) {
                statusMessage.textContent = 'Error: Please sign in again.';
                renderScreen(null, 'login');
                return;
            }

            renderScreen(user, 'quiz');
            quizTitle.textContent = `${topic} Assessment`;
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('assessment-status').textContent = `Please wait while the AI prepares your 20-question ${topic} test.`;
            document.getElementById('quiz-content').innerHTML = '';

            const systemPrompt = `You are an expert B.Tech course instructor. Generate exactly 20 challenging, fundamental multiple-choice questions (MCQs) for a ${topic} assessment. The questions must be appropriate for a university-level B.Tech student. Ensure the JSON output strictly follows the provided schema and contains exactly 20 items.`;
            
            let userQuery = '';
            if (topic.includes('Technical')) {
                userQuery = 'Generate 20 MCQs for the Technical Fundamentals assessment, covering core B.Tech syllabus concepts like Data Structures, Operating Systems, DBMS, and basic Networking.';
            } else if (topic.includes('Aptitude')) {
                userQuery = 'Generate 20 MCQs for the Aptitude & Reasoning test, covering logical deduction, quantitative analysis, number series, and spatial reasoning.';
            } else if (topic.includes('Behavioral')) {
                 userQuery = 'Generate 20 MCQs for the Behavioral Skills assessment focused on workplace scenarios related to communication, teamwork, conflict resolution, time management, and ethical decision-making.';
            } else {
                userQuery = `Generate 20 MCQs for the ${topic} assessment.`;
            }

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: quizSchema,
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("API response text was empty.");
                
                const questions = JSON.parse(jsonText);
                
                if (questions.length < 15) throw new Error(`Received too few questions (${questions.length}).`);
                
                currentQuizData = questions.slice(0, 20); // Always use at most 20 questions
                
                renderQuiz();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('assessment-status').textContent = `Test ready! Submit when finished.`;
                
            } catch (error) {
                console.error("Question generation failed:", error);
                
                if (attempts < 3) {
                    const delay = Math.pow(2, attempts) * 1000;
                    console.log(`Retrying in ${delay / 1000} seconds...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateQuiz(topic, attempts + 1);
                }

                document.getElementById('assessment-status').textContent = `Error: Could not generate test questions after several retries.`;
                document.getElementById('loader').classList.add('hidden');
                // Send user back to dashboard on failure
                renderScreen(user, 'dashboard');
            }
        }
        
        /**
         * Renders the generated quiz questions onto the screen. (Unchanged)
         */
        function renderQuiz() {
            const quizContent = document.getElementById('quiz-content');
            quizContent.innerHTML = '';
            
            if (currentQuizData.length === 0) {
                quizContent.innerHTML = '<p class="text-red-500">No questions loaded.</p>';
                return;
            }

            currentQuizData.forEach((item, index) => {
                const questionNumber = index + 1;
                const radioGroupName = `q${questionNumber}`; 
                
                const questionHtml = `
                    <div class="mb-8 p-4 border border-gray-100 bg-white rounded-lg shadow-md">
                        <p class="font-semibold text-lg mb-4 text-gray-800">Q${questionNumber}: ${item.question}</p>
                        <div class="space-y-2">
                            ${Object.keys(item.options).map(key => `
                                <label class="flex items-center p-3 rounded-md border border-gray-200 hover:bg-indigo-50 cursor-pointer transition duration-150">
                                    <input type="radio" name="${radioGroupName}" value="${key}" class="w-4 h-4 text-indigo-600 focus:ring-indigo-500 mr-3" required>
                                    <span class="text-gray-700 font-medium">${key}: ${item.options[key]}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                quizContent.insertAdjacentHTML('beforeend', questionHtml);
            });
            
            // Add submit and cancel buttons at the end
            quizContent.insertAdjacentHTML('beforeend', `
                <div class="mt-8 text-center">
                    <button type="submit" id="submit-quiz" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300">
                        Submit ${currentTopic} Assessment
                    </button>
                    <button type="button" id="back-to-dashboard-quiz" class="ml-4 px-4 py-3 bg-gray-300 text-gray-800 font-semibold rounded-xl hover:bg-gray-400 transition duration-300">
                        Cancel & Back
                    </button>
                </div>
            `);
            
            document.getElementById('back-to-dashboard-quiz').addEventListener('click', () => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    renderScreen(session?.user, 'dashboard');
                });
            });
        }
        
        /**
         * Calculates the score, saves the result (without displaying it), and displays the results screen with CTA.
         */
        async function handleSubmitQuiz(event) {
            event.preventDefault();
            const session = await supabase.auth.getSession();
            const user = session.data.session?.user || null;
            if (!user) return;

            let correctAnswers = 0;
            const form = event.target;
            const MAX_SCORE = currentQuizData.length;

            currentQuizData.forEach((question, index) => {
                const questionNumber = index + 1;
                const selectedOption = form.querySelector(`input[name="q${questionNumber}"]:checked`)?.value;
                
                if (selectedOption && selectedOption === question.answerKey) {
                    correctAnswers++;
                }
            });

            // 1. SAVE RESULT TO SUPABASE (Score is saved to the DB for the owner's review)
            await saveAssessmentResult(user.id, currentTopic, correctAnswers, MAX_SCORE);

            // 2. Display Results Screen (only topic name, no score)
            document.getElementById('results-topic').textContent = currentTopic;

            // 3. Render Results Screen
            renderScreen(user, 'results');
        }


        // --- 6. INITIALIZATION AND EVENT LISTENERS (Unchanged flow) ---
        
        // Supabase Auth State Listener
        if (supabase) {
            supabase.auth.onAuthStateChange((event, session) => {
                const user = session?.user || null;
                // If a user is present, render the dashboard (the landing page).
                renderScreen(user, 'dashboard'); 
            });
        }
        
        // Button Event Listeners
        googleSignInButton.addEventListener('click', signInWithGoogle);
        signOutButton.addEventListener('click', handleSignOut);
        
        // All three tests now start immediately with a click
        document.getElementById('start-technical').addEventListener('click', () => generateQuiz('Technical Fundamentals'));
        document.getElementById('start-aptitude').addEventListener('click', () => generateQuiz('Aptitude & Reasoning'));
        document.getElementById('start-behavioral').addEventListener('click', () => generateQuiz('Behavioral Skills'));
        
        // Quiz form submission listener (Uses event delegation on the static form element)
        quizForm.addEventListener('submit', handleSubmitQuiz);
        
        // Results screen listener
        document.getElementById('results-back-to-dashboard').addEventListener('click', () => {
            supabase.auth.getSession().then(({ data: { session } }) => {
                renderScreen(session?.user, 'dashboard');
            });
        });

    </script>
</body>
</html>
